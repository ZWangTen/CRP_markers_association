---
title: "Supplementary Info Preparation"
author: "Leslie (ZW)"
date: "2024-05-13"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(finalfit)
library(knitr)
library(forestploter)
library(grid)
library(ggplot2)
library(gridExtra)
```

# Create Supplementary Table S1
```{r}
pheno_MESA <-read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Data/MESA_data/20240229_MESA_crp.csv')
pheno_MESA <- pheno_MESA[complete.cases(pheno_MESA$crp1),]

pheno_MESA$CRP_group <- as.factor(ifelse(pheno_MESA$crp1<1, 'Low (<1)', 
                                        ifelse(pheno_MESA$crp1>3, 'High (>3)', 'Borderline (1-3)')))
pheno_MESA$CRP_group <- relevel(pheno_MESA$CRP_group, ref = 'Low (<1)' )
pheno_MESA$overall<-'Overall'

# Set labels to show in table without changing column names
pheno_MESA$crp1 <- pheno_MESA$crp1 %>%
  ff_label("CRP (mg/L)") 
pheno_MESA$gender1 <- pheno_MESA$gender1 %>%
  ff_label("Gender (%)") 
pheno_MESA$age1c <- pheno_MESA$age1c %>%
  ff_label("Age") 
pheno_MESA$bmi1c <- pheno_MESA$bmi1c %>%
  ff_label("BMI") 
pheno_MESA$race1c <- factor(pheno_MESA$race1c,levels = c("1","2","3","4"),
                          labels = c("White", "Chinese", "Black", "Hispanic/Latino"))

Demo_var <- c("age1c", "bmi1c", "crp1", 'gender1', 'race1c')
Tab.S1 <- pheno_MESA %>% 
  summary_factorlist("CRP_group", Demo_var, na_include=FALSE,cont = "mean") %>%
  ff_percent_only() 
# Keep only 1 level for variables with 2 levels
keep <- c(1:4,6:9) 
Tab.S1 <- Tab.S1[keep,]
Tab.S1.overall <- pheno_MESA %>% summary_factorlist('overall', Demo_var, na_include=FALSE, cont = "mean") %>%
  ff_percent_only()
Tab.S1.overall <- Tab.S1.overall[keep,]
Tab.S1 <- merge(Tab.S1, Tab.S1.overall, by=c('label','levels'))
# Rearrange the table
Tab.S1 <- Tab.S1[c(4:8,1:3), c(1,2,6,3:5)]
Tab.S1$levels[4] <- 'Female'
Tab.S1$label[5] <- ''
Tab.S1$Variable <- NA
Tab.S1$Variable[c(1:3)] <- paste0(Tab.S1$label[c(1:3)], ' (', Tab.S1$levels[c(1:3)], ')')
Tab.S1$Variable[4] <- paste0(Tab.S1$label[4], ' - ', Tab.S1$levels[4])
Tab.S1$Variable[5:8] <- Tab.S1$levels[5:8]
Tab.S1 <- Tab.S1[,c(7,3:6)]
group_name <- data.frame(Variable='Race (%)', Overall=rep(NA,1), Low=rep(NA,1), 
                                    Borderline=rep(NA,1), High=rep(NA,1) )
names(group_name)[3:5] <- names(Tab.S1)[3:5]
Tab.S1 <- rbind(Tab.S1, group_name)
Tab.S1 <- Tab.S1[c(1:4,9,5:8),]
Tab.S1[is.na(Tab.S1)] <- ''
kable(Tab.S1, row.names = FALSE)
#write.csv(Tab.S1, '~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Draft/Tables and Figures/Table_S1.csv', row.names = FALSE)
```

# Create Figure S1
```{r, fig.width=10}
# Read data
rmrs <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Survey regression/20240629_MrsCrp_Svy.csv')
rprs <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Survey regression/20240523_PRS_CRP.csv')
pl <- rbind(rmrs,rprs)

pl <- pl[order(pl$pheno),]
row.names(pl)<-1:nrow(pl)
pl$se <- (pl$upper - pl$lower) / (2 * qnorm(0.975))
names(pl) <- c('name','beta','pvalue','lower','upper','CRP_measures','se')

data <- pl[26:29,]
data$labels <- paste0(data$pheno,' (',data$group,')')
data$CRP_measures <- c("MRS-CRP",  "PRS-EUR",  "PRS-wsum-All", 'PRS-wsum-Hispanic')

fc <- data.frame(labels = data$CRP_measures, Beta = round(data$beta,2),
                 lower=round(data$lower,2),upper=round(data$upper,2),
                 p.value=format(data$pvalue, scientific=TRUE, digits=2))

fc$labels<-as.factor(fc$labels)
fc<-fc[order(fc$labels),]
fc$colour<-c('white','gray95','white','gray95')

fctab <- as.data.frame(apply(fc,2,as.character))
fctab$ci<-paste0(fctab$Beta,'  (',fctab$lower, ' - ',fctab$upper,')')
fctab$colour<-c('white','gray95','white','gray95')
fctab <-rbind(fctab,data.frame(labels = "Association", Beta= "", lower = "", upper = "", 
                               p.value = "p-value",ci="Coefficient (95% CI)",colour='white'))
fctab$labels = fct_rev(relevel(as.factor(fctab$labels), "Association"))

mid<-ggplot(fc,aes(y = fct_rev(labels),x=Beta,xmin=lower,xmax=upper)) + theme_classic()  +
  geom_hline(aes(yintercept = labels, colour = colour), size = 7) +scale_colour_identity() +
   geom_point(aes(x=Beta), shape=15, size=3) + 
  geom_linerange(aes(xmin=lower, xmax=upper)) + geom_vline(xintercept = 0, linetype="dashed") +
  annotate("text", x = .1, y = 12, label = "Blood-CRP",fontface='bold') +
  coord_cartesian(ylim=c(1,5)) +
  labs(x="Coefficient Estimate",y='') + theme(legend.position="none") +
  theme(axis.line.y = element_blank(), axis.ticks.y= element_blank(),
        axis.text.y= element_blank(), axis.title.y= element_blank())

tab<-ggplot(data = fctab, aes(y = labels)) +
  geom_hline(aes(yintercept = labels, colour = colour), size = 7) +
  geom_text(aes(x = 0, label = labels), hjust = 0, fontface = "bold") +
  geom_text(aes(x = 4, label = ci), fontface = ifelse(fctab$ci == "Coefficient (95% CI)", "bold", "plain")) +
  geom_text(aes(x = 7, label = p.value), hjust = 1,fontface = ifelse(fctab$p.value == "p-value", "bold", "plain")) +
  scale_colour_identity() +
  theme_void() +
  theme(plot.margin = margin(5, 0, 35, 0))

grid.arrange(tab,mid,ncol=2)

```

# Create Figure S2
## Data Preparation
```{r}
rmrs1 <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Survey regression/20240704_MrsCrp_Svy.csv')
rmrs1 <- rmrs1[1:14,]
rmrs1$fdr <- p.adjust(rmrs1$p.val,method='fdr')
rmrs1$pheno[c(7:8)] <- c('cog_global', 'cog_change')
rmrs1$group <- 'Model 1'
rmrs2 <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Survey regression/20240704_MRSCRP_mod2.csv')
rmrs2 <- rmrs2[1:14,]
rmrs2$fdr <- p.adjust(rmrs2$p.val,method='fdr')
rmrs2$pheno[c(7:8)] <- c('cog_global', 'cog_change')
rmrs2$group <- 'Model 2'

pl <- rbind(rmrs1,rmrs2)
pl <- pl[order(pl$pheno),]
row.names(pl) <- 1:nrow(pl)
FigS2A <- pl[c(19:28, 1:4),]
FigS2B <- pl[c(7:8, 11:12, 15:18, 5:6, 9:10),]
FigS2B$coef <- exp(FigS2B$coef)
FigS2B$lower <- exp(FigS2B$lower)
FigS2B$upper <- exp(FigS2B$upper)
```

## Fig S2A
```{r, fig.width=10}
row.names(FigS2A) <- 1:nrow(FigS2A)
sub <- split(FigS2A, FigS2A$group) 
m1 <- sub[[1]] %>% dplyr::select(-c(group))
names(m1)<-paste0('m1_', names(m1))
m2 <- sub[[2]]%>% dplyr::select(-c(group)) 
names(m2) <- paste0('m2_',names(m2))

FigS2A <- cbind(m1, m2) %>% dplyr::select(-c(m2_pheno))
names(FigS2A)[1] <- 'Phenotype'

FigS2A <- rbind(FigS2A,data.frame(Phenotype=c('Obstructive Sleep Apnea and Sleep Duration',
                                             'Cognitive Function'),
                           m1_coef=rep(NA,2), m1_p.val=rep(NA,2), m1_lower=rep(NA,2), 
                           m1_upper=rep(NA,2), m1_fdr=rep(NA,2), m2_fdr=rep(NA,2),
                           m2_coef=rep(NA,2), m2_p.val=rep(NA,2), m2_lower=rep(NA,2),
                           m2_upper=rep(NA,2)))
FigS2A <- FigS2A[c(8,1:5,9,7,6),]
row.names(FigS2A) <- 1:nrow(FigS2A)
FigS2A$Phenotype[c(2:6,8:9)] <- c('AHI','Minimum SpO2','Mean SpO2','% Time SpO2 <90',
                                  'Sleep Duration','Baseline', 'Cognitive Change')
FigS2A$Phenotype <- ifelse(is.na(FigS2A$m1_coef), 
                      FigS2A$Phenotype,
                      paste0("   ", FigS2A$Phenotype))
# NA to blank or NA will be transformed to carachter.
FigS2A$m1_coef<-round(FigS2A$m1_coef,3)
FigS2A$m2_coef<-round(FigS2A$m2_coef,3)
FigS2A$m1_p.val<-format(FigS2A$m1_p.val, scientific=TRUE, digits=2)
FigS2A$m2_p.val<-format(FigS2A$m2_p.val, scientific=TRUE, digits=2)
FigS2A$m1_fdr <- format(FigS2A$m1_fdr, scientific=TRUE, digit=2)
FigS2A$m2_fdr <- format(FigS2A$m2_fdr, scientific=TRUE, digit=2)

# Add two blank columns for CI
FigS2A$`95% CI` <- paste(rep(" ", 50), collapse = " ")
# Generate point estimation and 95% CI. Paste two CIs together and separate by line break.
FigS2A$m1_lower <- round(FigS2A$m1_lower,3)
FigS2A$m2_lower <- round(FigS2A$m2_lower,3)
FigS2A$m1_upper <- round(FigS2A$m1_upper,4)
FigS2A$m2_upper <- round(FigS2A$m2_upper,3)

FigS2A$CI <- paste(sprintf("(%.2f, %.2f)", FigS2A$m1_lower, FigS2A$m1_upper), 
                sprintf("(%.2f, %.2f)", FigS2A$m2_lower, FigS2A$m2_upper), 
                sep = "\n")
FigS2A$Beta <- paste(sprintf("%.2f", FigS2A$m1_coef),
                sprintf("%.2f", FigS2A$m2_coef),
                sep = "\n")
FigS2A$p.val <- paste(FigS2A$m1_p.val, FigS2A$m2_p.val,
                sep = "\n")
FigS2A$q.val <- paste(FigS2A$m1_fdr, FigS2A$m2_fdr, sep = "\n")

FigS2A$CI[grepl("NA", FigS2A$CI)] <- "" # Any NA to blank
FigS2A$Beta[grepl("NA", FigS2A$Beta)] <- "" # Any NA to blank
FigS2A$p.val[grepl("NA", FigS2A$p.val)] <- "" # Any NA to blank
FigS2A$q.val[grepl("NA", FigS2A$q.val)] <- "" # Any NA to blank

#################### plot
# Set-up theme
tm <- forest_theme(base_size = 8,
                   refline_lty = "solid",
                   ci_pch = c(15, 18),
                   ci_col = c( "#AF0040","#377eb8"),
                   footnote_gp = gpar(col = "blue"),
                   legend_name = "Model",
                   legend_value = c("Model 1", "Model 2" ),
                   vertline_lty = c("dashed", "dotted"),
                   vertline_col = c("#d6604d", "#bababa"),
                   # Table cell padding, width 4 and heights 3
                   )
#> refline_lty will be deprecated, use refline_gp instead.
names(FigS2A)[13]<-'95%CI'
plot <- forest(FigS2A[,c(1,14,15,16,13,12)], 
            est = list(FigS2A$m1_coef,
                       FigS2A$m2_coef),
            lower = list(FigS2A$m1_lower,
                         FigS2A$m2_lower),
            upper = list(FigS2A$m1_upper,
                         FigS2A$m2_upper),
            ci_column = 6,
            ref_line = 0, 
            theme = tm)
plot
```

## Fig S2B
```{r, fig.width=10}
row.names(FigS2B) <- 1:nrow(FigS2B)
sub <- split(FigS2B, FigS2B$group) 
m1 <- sub[[1]] %>% dplyr::select(-c(group))
names(m1) <- paste0('m1_', names(m1))
m2 <- sub[[2]]%>% dplyr::select(-c(group))
names(m2) <- paste0('m2_', names(m2))
FigS2B <- cbind(m1,m2) %>% dplyr::select(-c(m2_pheno))
names(FigS2B)[1] <- 'Phenotype'

FigS2B <- rbind(FigS2B, data.frame(Phenotype=c('Other Sleep Traits','Metabolic comorbidities'),
                           m1_coef=rep(NA,2),m1_p.val=rep(NA,2), m1_lower=rep(NA,2),
                           m1_upper=rep(NA,2), m1_fdr=rep(NA,2), m2_fdr=rep(NA,2),
                           m2_coef=rep(NA,2), m2_p.val=rep(NA,2),m2_lower=rep(NA,2),m2_upper=rep(NA,2) ))
FigS2B <- FigS2B[c(7,1:4, 8,5:6),]
row.names(FigS2B) <- 1:nrow(FigS2B)
FigS2B$Phenotype[c(2,4:5,7:8)] <- c('Excessive daytime sleepiness', 'Long Sleep', 'Short Sleep',
                                    'Diabetes', 'Hypertension')
FigS2B$Phenotype <- ifelse(is.na(FigS2B$m1_coef), 
                      FigS2B$Phenotype,
                      paste0("   ", FigS2B$Phenotype))
# NA to blank or NA will be transformed to carachter.
FigS2B$m1_coef<-round(FigS2B$m1_coef,3)
FigS2B$m2_coef<-round(FigS2B$m2_coef,3)
FigS2B$m1_p.val<-format(FigS2B$m1_p.val, scientific=TRUE, digits=2)
FigS2B$m2_p.val<-format(FigS2B$m2_p.val, scientific=TRUE, digits=2)
FigS2B$m1_fdr <- format(FigS2B$m1_fdr, scientific=TRUE, digit=2)
FigS2B$m2_fdr <- format(FigS2B$m2_fdr, scientific=TRUE, digit=2)

# Add two m1ank columns for CI
FigS2B$`95% CI` <- paste(rep(" ", 50), collapse = " ")
# Generate point estimation and 95% CI. Paste two CIs together and separate by line break.
FigS2B$m1_lower <- round(FigS2B$m1_lower,3)
FigS2B$m2_lower <- round(FigS2B$m2_lower,3)
FigS2B$m1_upper <- round(FigS2B$m1_upper,3)
FigS2B$m2_upper <- round(FigS2B$m2_upper,3)

FigS2B$CI <- paste(sprintf("(%.2f, %.2f)", FigS2B$m1_lower, FigS2B$m1_upper),
                sprintf("(%.2f, %.2f)", FigS2B$m2_lower, FigS2B$m2_upper),
                sep = "\n")
FigS2B$Beta <- paste(sprintf("%.2f", FigS2B$m1_coef),
                sprintf("%.2f", FigS2B$m2_coef),
                sep = "\n")
FigS2B$p.val <- paste( FigS2B$m1_p.val, FigS2B$m2_p.val,
                sep = "\n")
FigS2B$q.val <- paste(FigS2B$m1_fdr, FigS2B$m2_fdr, sep = "\n")

FigS2B$CI[grepl("NA", FigS2B$CI)] <- "" # Any NA to blank
FigS2B$Beta[grepl("NA", FigS2B$Beta)] <- "" # Any NA to blank
FigS2B$p.val[grepl("NA", FigS2B$p.val)]<- ""
FigS2B$q.val[grepl("NA", FigS2B$q.val)] <- "" # Any NA to blank

#################### plot
names(FigS2B)[13] <- '95%CI'
names(FigS2B)[14] <- 'Odds Ratio'
plot <- forest(FigS2B[,c(1,14,15,16,13,12)], 
            est = list(FigS2B$m1_coef,
                       FigS2B$m2_coef),
            lower = list(FigS2B$m1_lower,
                         FigS2B$m2_lower),
            upper = list(FigS2B$m1_upper,
                         FigS2B$m2_upper),
            ci_column = 6,
            ref_line = 1, 
            theme = tm)
plot
```

# Create Figure S3

## Fig S3A
```{r, fig.width=10}
womrs <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Survey regression/20240704_slp_dis_wo.csv')

# Figure S3A
pnum <- womrs[-c(4,5,9,10,14,15,19,20),]
pnum <- pnum[order(pnum$pheno),]
row.names(pnum)<-1:nrow(pnum)

sub <- split(pnum,pnum$condition) 
bas <- sub[[1]] %>% dplyr::select(-c(condition)) # baseline
names(bas) <- paste0('bas_', names(bas))
cha <- sub[[2]] %>% dplyr::select(-c(condition)) # change
names(cha) <- paste0('cha_', names(cha))
dia<-sub[[3]] %>% dplyr::select(-c(condition)) # diab
names(dia) <- paste0('dia_', names(dia))
hyp<-sub[[4]] %>% dplyr::select(-c(condition)) # hyp
names(hyp) <- paste0('hyp_', names(hyp))
pnum<-cbind(bas, cha, dia, hyp) %>% dplyr::select(-c(cha_pheno, dia_pheno, hyp_pheno))
names(pnum)[1] <- 'Phenotype'

pnum <- rbind(pnum,data.frame(Phenotype=c('Without adjusting for MRS_CRP'),
                           bas_coef=rep(NA,1), bas_p.val=rep(NA,1), bas_lower=rep(NA,1), 
                           bas_upper=rep(NA,1), cha_coef=rep(NA,1), cha_p.val=rep(NA,1),
                           cha_lower=rep(NA,1), cha_upper=rep(NA,1), dia_coef=rep(NA,1), 
                           dia_p.val=rep(NA,1), dia_lower=rep(NA,1), dia_upper=rep(NA,1),
                           hyp_coef=rep(NA,1), hyp_p.val=rep(NA,1), hyp_lower=rep(NA,1),
                           hyp_upper=rep(NA,1)))
pnum <- pnum[c(4,1:3),]
row.names(pnum) <- 1:nrow(pnum)
pnum$Phenotype[c(2:4)] <- c('AHI','Minimum SpO2','Mean SpO2')

pnum$Phenotype <- ifelse(is.na(pnum$bas_coef), 
                      pnum$Phenotype,
                      paste0("   ", pnum$Phenotype))
# NA to blank or NA will be transformed to carachter.
pnum$bas_coef <- round(pnum$bas_coef,3)
pnum$cha_coef <- round(pnum$cha_coef,3)
pnum$hyp_coef <- round(pnum$hyp_coef,3)
pnum$dia_coef <- round(pnum$dia_coef,3)
pnum$bas_p.val <- format(pnum$bas_p.val, digits=2, scientific=TRUE)
pnum$cha_p.val <- format(pnum$cha_p.val, digits=2, scientific=TRUE)
pnum$hyp_p.val <- format(pnum$hyp_p.val, digits=2, scientific=TRUE)
pnum$dia_p.val <- format(pnum$dia_p.val, digits=2, scientific=TRUE)

# Add two basank columns for CI
pnum$`95% CI` <- paste(rep(" ", 50), collapse = " ")
# Generate point estimation and 95% CI. Paste two CIs together and separate by line break.
pnum$bas_lower <- round(pnum$bas_lower,3)
pnum$cha_lower <- round(pnum$cha_lower,3)
pnum$hyp_lower <- round(pnum$hyp_lower,3)
pnum$dia_lower <- round(pnum$dia_lower,3)
pnum$bas_upper <- round(pnum$bas_upper,4)
pnum$cha_upper <- round(pnum$cha_upper,3)
pnum$hyp_upper <- round(pnum$hyp_upper,3)
pnum$dia_upper <- round(pnum$dia_upper,3)

pnum$CI <- paste(sprintf("(%.2f, %.2f)", pnum$bas_lower, pnum$bas_upper), 
                sprintf("(%.2f, %.2f)", pnum$cha_lower, pnum$cha_upper),
                sprintf("(%.2f, %.2f)", pnum$dia_lower, pnum$dia_upper),
                sprintf("(%.2f, %.2f)", pnum$hyp_lower, pnum$hyp_upper),
                sep = "\n")
pnum$Beta <- paste(sprintf("%.2f", pnum$bas_coef),
                sprintf("%.2f", pnum$cha_coef),
                sprintf("%.2f", pnum$dia_coef),
                sprintf("%.2f", pnum$hyp_coef),
                sep = "\n")
pnum$p.val <- paste( pnum$bas_p.val, pnum$cha_p.val, pnum$dia_p.val, pnum$hyp_p.val,
                sep = "\n")
pnum$CI[grepl("NA", pnum$CI)] <- "" # Any NA to blank
pnum$Beta[grepl("NA", pnum$Beta)] <- "" # Any NA to blank
pnum$p.val[grepl("NA", pnum$p.val)] <- "" # Any NA to blank

#################### plot
tm <- forest_theme(base_size = 8,
                   refline_lty = "solid",
                   ci_pch = c(15, 18),
                   ci_col = c("#762a83", "#AF0040","#377eb8","#4daf4a"),
                   footnote_gp = gpar(col = "blue"),
                   legend_name = "CRP_Type",
                   legend_value = c("Cog_baseline", "Cog_change", "Diabetes",  "Hypertension" ),
                   vertline_lty = c("dashed", "dotted"),
                   vertline_col = c("#d6604d", "#bababa"),
                   # Table cell padding, width 4 and heights 3
                   )
names(pnum)[20] <- 'Beta or OR'
plot <- forest(pnum[,c(1,20,21,19,18)],
            est = list(pnum$bas_coef,
                       pnum$cha_coef,
                       pnum$dia_coef,
                       pnum$hyp_coef),
            lower = list(pnum$bas_lower,
                         pnum$cha_lower,
                         pnum$dia_lower,
                         pnum$hyp_lower), 
            upper = list(pnum$bas_upper,
                         pnum$cha_upper,
                         pnum$dia_upper,
                         pnum$hyp_upper),
            ci_column = 5,
            ref_line = 0, # 1
            theme = tm)

plot

##############
pnum <- womrs[c(4,5,9,10,14,15,19,20),]
pnum <- pnum[order(pnum$pheno),]
row.names(pnum)<-1:nrow(pnum)
pnum$coef <- exp(pnum$coef)
pnum$lower <- exp(pnum$lower)
pnum$upper <- exp(pnum$upper)

sub <- split(pnum,pnum$condition) 
bas <- sub[[1]] %>% dplyr::select(-c(condition)) # baseline
names(bas) <- paste0('bas_', names(bas))
cha <- sub[[2]] %>% dplyr::select(-c(condition)) # change
names(cha) <- paste0('cha_', names(cha))
dia<-sub[[3]] %>% dplyr::select(-c(condition)) # diab
names(dia) <- paste0('dia_', names(dia))
hyp<-sub[[4]] %>% dplyr::select(-c(condition)) # hyp
names(hyp) <- paste0('hyp_', names(hyp))
pnum<-cbind(bas, cha, dia, hyp) %>% dplyr::select(-c(cha_pheno, dia_pheno, hyp_pheno))
names(pnum)[1] <- 'Phenotype'

pnum <- rbind(pnum,data.frame(Phenotype=c('Without adjusting for MRS_CRP'),
                           bas_coef=rep(NA,1), bas_p.val=rep(NA,1), bas_lower=rep(NA,1), 
                           bas_upper=rep(NA,1), cha_coef=rep(NA,1), cha_p.val=rep(NA,1),
                           cha_lower=rep(NA,1), cha_upper=rep(NA,1), dia_coef=rep(NA,1), 
                           dia_p.val=rep(NA,1), dia_lower=rep(NA,1), dia_upper=rep(NA,1),
                           hyp_coef=rep(NA,1), hyp_p.val=rep(NA,1), hyp_lower=rep(NA,1),
                           hyp_upper=rep(NA,1)))
pnum <- pnum[c(3,1:2),]
pnum$Phenotype <- ifelse(is.na(pnum$bas_coef), 
                      pnum$Phenotype,
                      paste0("   ", pnum$Phenotype))
# NA to blank or NA will be transformed to carachter.
pnum$bas_coef <- round(pnum$bas_coef,3)
pnum$cha_coef <- round(pnum$cha_coef,3)
pnum$hyp_coef <- round(pnum$hyp_coef,3)
pnum$dia_coef <- round(pnum$dia_coef,3)
pnum$bas_p.val <- format(pnum$bas_p.val, digits=2, scientific=TRUE)
pnum$cha_p.val <- format(pnum$cha_p.val, digits=2, scientific=TRUE)
pnum$hyp_p.val <- format(pnum$hyp_p.val, digits=2, scientific=TRUE)
pnum$dia_p.val <- format(pnum$dia_p.val, digits=2, scientific=TRUE)

# Add two basank columns for CI
pnum$`95% CI` <- paste(rep(" ", 50), collapse = " ")
# Generate point estimation and 95% CI. Paste two CIs together and separate by line break.
pnum$bas_lower <- round(pnum$bas_lower,3)
pnum$cha_lower <- round(pnum$cha_lower,3)
pnum$hyp_lower <- round(pnum$hyp_lower,3)
pnum$dia_lower <- round(pnum$dia_lower,3)
pnum$bas_upper <- round(pnum$bas_upper,4)
pnum$cha_upper <- round(pnum$cha_upper,3)
pnum$hyp_upper <- round(pnum$hyp_upper,3)
pnum$dia_upper <- round(pnum$dia_upper,3)

pnum$CI <- paste(sprintf("(%.2f, %.2f)", pnum$bas_lower, pnum$bas_upper), 
                sprintf("(%.2f, %.2f)", pnum$cha_lower, pnum$cha_upper),
                sprintf("(%.2f, %.2f)", pnum$dia_lower, pnum$dia_upper),
                sprintf("(%.2f, %.2f)", pnum$hyp_lower, pnum$hyp_upper),
                sep = "\n")
pnum$Beta <- paste(sprintf("%.2f", pnum$bas_coef),
                sprintf("%.2f", pnum$cha_coef),
                sprintf("%.2f", pnum$dia_coef),
                sprintf("%.2f", pnum$hyp_coef),
                sep = "\n")
pnum$p.val <- paste( pnum$bas_p.val, pnum$cha_p.val, pnum$dia_p.val, pnum$hyp_p.val,
                sep = "\n")
pnum$CI[grepl("NA", pnum$CI)] <- "" # Any NA to blank
pnum$Beta[grepl("NA", pnum$Beta)] <- "" # Any NA to blank
pnum$p.val[grepl("NA", pnum$p.val)] <- "" # Any NA to blank

tm <- forest_theme(base_size = 8,
                   refline_lty = "solid",
                   ci_pch = c(15, 18),
                   ci_col = c("#762a83", "#AF0040","#377eb8","#4daf4a"),
                   footnote_gp = gpar(col = "blue"),
                   legend_name = "CRP_Type",
                   legend_value = c("", "", "",  "" ),
                   vertline_lty = c("dashed", "dotted"),
                   vertline_col = c("#d6604d", "#bababa"),
                   # Table cell padding, width 4 and heights 3
                   )
names(pnum)[20] <- 'Beta or OR'
plot <- forest(pnum[,c(1,20,21,19,18)],
            est = list(pnum$bas_coef,
                       pnum$cha_coef,
                       pnum$dia_coef,
                       pnum$hyp_coef),
            lower = list(pnum$bas_lower,
                         pnum$cha_lower,
                         pnum$dia_lower,
                         pnum$hyp_lower), 
            upper = list(pnum$bas_upper,
                         pnum$cha_upper,
                         pnum$dia_upper,
                         pnum$hyp_upper),
            ci_column = 5,
            ref_line = 1, # 1
            theme = tm)

plot

```

## Fig S3B
```{r, fig.width=10}
wmrs <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Survey regression/20240704_slp_dis_w.csv')

# Figure S3B
pnum <- wmrs[-c(4,5,9,10,14,15,19,20),]
pnum <- pnum[order(pnum$pheno),]
row.names(pnum)<-1:nrow(pnum)

sub <- split(pnum,pnum$condition) 
bas <- sub[[1]] %>% dplyr::select(-c(condition)) # baseline
names(bas) <- paste0('bas_', names(bas))
cha <- sub[[2]] %>% dplyr::select(-c(condition)) # change
names(cha) <- paste0('cha_', names(cha))
dia<-sub[[3]] %>% dplyr::select(-c(condition)) # diab
names(dia) <- paste0('dia_', names(dia))
hyp<-sub[[4]] %>% dplyr::select(-c(condition)) # hyp
names(hyp) <- paste0('hyp_', names(hyp))
pnum<-cbind(bas, cha, dia, hyp) %>% dplyr::select(-c(cha_pheno, dia_pheno, hyp_pheno))
names(pnum)[1] <- 'Phenotype'

pnum <- rbind(pnum,data.frame(Phenotype=c('Adjusting for MRS_CRP'),
                           bas_coef=rep(NA,1), bas_p.val=rep(NA,1), bas_lower=rep(NA,1), 
                           bas_upper=rep(NA,1), cha_coef=rep(NA,1), cha_p.val=rep(NA,1),
                           cha_lower=rep(NA,1), cha_upper=rep(NA,1), dia_coef=rep(NA,1), 
                           dia_p.val=rep(NA,1), dia_lower=rep(NA,1), dia_upper=rep(NA,1),
                           hyp_coef=rep(NA,1), hyp_p.val=rep(NA,1), hyp_lower=rep(NA,1),
                           hyp_upper=rep(NA,1)))
pnum <- pnum[c(4,1:3),]
row.names(pnum) <- 1:nrow(pnum)
pnum$Phenotype[c(2:4)] <- c('AHI','Minimum SpO2','Mean SpO2')

pnum$Phenotype <- ifelse(is.na(pnum$bas_coef), 
                      pnum$Phenotype,
                      paste0("   ", pnum$Phenotype))
# NA to blank or NA will be transformed to carachter.
pnum$bas_coef <- round(pnum$bas_coef,3)
pnum$cha_coef <- round(pnum$cha_coef,3)
pnum$hyp_coef <- round(pnum$hyp_coef,3)
pnum$dia_coef <- round(pnum$dia_coef,3)
pnum$bas_p.val <- format(pnum$bas_p.val, digits=2, scientific=TRUE)
pnum$cha_p.val <- format(pnum$cha_p.val, digits=2, scientific=TRUE)
pnum$hyp_p.val <- format(pnum$hyp_p.val, digits=2, scientific=TRUE)
pnum$dia_p.val <- format(pnum$dia_p.val, digits=2, scientific=TRUE)

# Add two basank columns for CI
pnum$`95% CI` <- paste(rep(" ", 50), collapse = " ")
# Generate point estimation and 95% CI. Paste two CIs together and separate by line break.
pnum$bas_lower <- round(pnum$bas_lower,3)
pnum$cha_lower <- round(pnum$cha_lower,3)
pnum$hyp_lower <- round(pnum$hyp_lower,3)
pnum$dia_lower <- round(pnum$dia_lower,3)
pnum$bas_upper <- round(pnum$bas_upper,4)
pnum$cha_upper <- round(pnum$cha_upper,3)
pnum$hyp_upper <- round(pnum$hyp_upper,3)
pnum$dia_upper <- round(pnum$dia_upper,3)

pnum$CI <- paste(sprintf("(%.2f, %.2f)", pnum$bas_lower, pnum$bas_upper), 
                sprintf("(%.2f, %.2f)", pnum$cha_lower, pnum$cha_upper),
                sprintf("(%.2f, %.2f)", pnum$dia_lower, pnum$dia_upper),
                sprintf("(%.2f, %.2f)", pnum$hyp_lower, pnum$hyp_upper),
                sep = "\n")
pnum$Beta <- paste(sprintf("%.2f", pnum$bas_coef),
                sprintf("%.2f", pnum$cha_coef),
                sprintf("%.2f", pnum$dia_coef),
                sprintf("%.2f", pnum$hyp_coef),
                sep = "\n")
pnum$p.val <- paste(pnum$bas_p.val, pnum$cha_p.val, pnum$dia_p.val, pnum$hyp_p.val,
                sep = "\n")
pnum$CI[grepl("NA", pnum$CI)] <- "" # Any NA to blank
pnum$Beta[grepl("NA", pnum$Beta)] <- "" # Any NA to blank
pnum$p.val[grepl("NA", pnum$p.val)] <- "" # Any NA to blank

#################### plot
tm <- forest_theme(base_size = 8,
                   refline_lty = "solid",
                   ci_pch = c(15, 18),
                   ci_col = c("#762a83", "#AF0040","#377eb8","#4daf4a"),
                   footnote_gp = gpar(col = "blue"),
                   legend_name = "CRP_Type",
                   legend_value = c("Cog_baseline", "Cog_change", "Diabetes",  "Hypertension" ),
                   vertline_lty = c("dashed", "dotted"),
                   vertline_col = c("#d6604d", "#bababa"),
                   # Table cell padding, width 4 and heights 3
                   )
names(pnum)[20] <- 'Beta or OR'
plot <- forest(pnum[,c(1,20,21,19,18)],
            est = list(pnum$bas_coef,
                       pnum$cha_coef,
                       pnum$dia_coef,
                       pnum$hyp_coef),
            lower = list(pnum$bas_lower,
                         pnum$cha_lower,
                         pnum$dia_lower,
                         pnum$hyp_lower), 
            upper = list(pnum$bas_upper,
                         pnum$cha_upper,
                         pnum$dia_upper,
                         pnum$hyp_upper),
            ci_column = 5,
            ref_line = 0, # 1
            theme = tm)

plot

##############
pnum <- wmrs[c(4,5,9,10,14,15,19,20),]
pnum <- pnum[order(pnum$pheno),]
row.names(pnum)<-1:nrow(pnum)
pnum$coef <- exp(pnum$coef)
pnum$lower <- exp(pnum$lower)
pnum$upper <- exp(pnum$upper)

sub <- split(pnum,pnum$condition) 
bas <- sub[[1]] %>% dplyr::select(-c(condition)) # baseline
names(bas) <- paste0('bas_', names(bas))
cha <- sub[[2]] %>% dplyr::select(-c(condition)) # change
names(cha) <- paste0('cha_', names(cha))
dia<-sub[[3]] %>% dplyr::select(-c(condition)) # diab
names(dia) <- paste0('dia_', names(dia))
hyp<-sub[[4]] %>% dplyr::select(-c(condition)) # hyp
names(hyp) <- paste0('hyp_', names(hyp))
pnum<-cbind(bas, cha, dia, hyp) %>% dplyr::select(-c(cha_pheno, dia_pheno, hyp_pheno))
names(pnum)[1] <- 'Phenotype'

pnum <- rbind(pnum,data.frame(Phenotype=c('Adjusting for MRS_CRP'),
                           bas_coef=rep(NA,1), bas_p.val=rep(NA,1), bas_lower=rep(NA,1), 
                           bas_upper=rep(NA,1), cha_coef=rep(NA,1), cha_p.val=rep(NA,1),
                           cha_lower=rep(NA,1), cha_upper=rep(NA,1), dia_coef=rep(NA,1), 
                           dia_p.val=rep(NA,1), dia_lower=rep(NA,1), dia_upper=rep(NA,1),
                           hyp_coef=rep(NA,1), hyp_p.val=rep(NA,1), hyp_lower=rep(NA,1),
                           hyp_upper=rep(NA,1)))
pnum <- pnum[c(3,1:2),]
pnum$Phenotype <- ifelse(is.na(pnum$bas_coef), 
                      pnum$Phenotype,
                      paste0("   ", pnum$Phenotype))
# NA to blank or NA will be transformed to carachter.
pnum$bas_coef <- round(pnum$bas_coef,3)
pnum$cha_coef <- round(pnum$cha_coef,3)
pnum$hyp_coef <- round(pnum$hyp_coef,3)
pnum$dia_coef <- round(pnum$dia_coef,3)
pnum$bas_p.val <- format(pnum$bas_p.val, digits=2, scientific=TRUE)
pnum$cha_p.val <- format(pnum$cha_p.val, digits=2, scientific=TRUE)
pnum$hyp_p.val <- format(pnum$hyp_p.val, digits=2, scientific=TRUE)
pnum$dia_p.val <- format(pnum$dia_p.val, digits=2, scientific=TRUE)

# Add two basank columns for CI
pnum$`95% CI` <- paste(rep(" ", 50), collapse = " ")
# Generate point estimation and 95% CI. Paste two CIs together and separate by line break.
pnum$bas_lower <- round(pnum$bas_lower,3)
pnum$cha_lower <- round(pnum$cha_lower,3)
pnum$hyp_lower <- round(pnum$hyp_lower,3)
pnum$dia_lower <- round(pnum$dia_lower,3)
pnum$bas_upper <- round(pnum$bas_upper,4)
pnum$cha_upper <- round(pnum$cha_upper,3)
pnum$hyp_upper <- round(pnum$hyp_upper,3)
pnum$dia_upper <- round(pnum$dia_upper,3)

pnum$CI <- paste(sprintf("(%.2f, %.2f)", pnum$bas_lower, pnum$bas_upper), 
                sprintf("(%.2f, %.2f)", pnum$cha_lower, pnum$cha_upper),
                sprintf("(%.2f, %.2f)", pnum$dia_lower, pnum$dia_upper),
                sprintf("(%.2f, %.2f)", pnum$hyp_lower, pnum$hyp_upper),
                sep = "\n")
pnum$Beta <- paste(sprintf("%.2f", pnum$bas_coef),
                sprintf("%.2f", pnum$cha_coef),
                sprintf("%.2f", pnum$dia_coef),
                sprintf("%.2f", pnum$hyp_coef),
                sep = "\n")
pnum$p.val <- paste( pnum$bas_p.val, pnum$cha_p.val, pnum$dia_p.val, pnum$hyp_p.val,
                sep = "\n")
pnum$CI[grepl("NA", pnum$CI)] <- "" # Any NA to blank
pnum$Beta[grepl("NA", pnum$Beta)] <- "" # Any NA to blank
pnum$p.val[grepl("NA", pnum$p.val)] <- "" # Any NA to blank

tm <- forest_theme(base_size = 8,
                   refline_lty = "solid",
                   ci_pch = c(15, 18),
                   ci_col = c("#762a83", "#AF0040","#377eb8","#4daf4a"),
                   footnote_gp = gpar(col = "blue"),
                   legend_name = "CRP_Type",
                   legend_value = c("", "", "",  "" ),
                   vertline_lty = c("dashed", "dotted"),
                   vertline_col = c("#d6604d", "#bababa"),
                   # Table cell padding, width 4 and heights 3
                   )
names(pnum)[20] <- 'Beta or OR'
plot <- forest(pnum[,c(1,20,21,19,18)],
            est = list(pnum$bas_coef,
                       pnum$cha_coef,
                       pnum$dia_coef,
                       pnum$hyp_coef),
            lower = list(pnum$bas_lower,
                         pnum$cha_lower,
                         pnum$dia_lower,
                         pnum$hyp_lower), 
            upper = list(pnum$bas_upper,
                         pnum$cha_upper,
                         pnum$dia_upper,
                         pnum$hyp_upper),
            ci_column = 5,
            ref_line = 1, # 1
            theme = tm)

plot
```

# Create Figure S4

## Data Preparation
```{r}
woprs <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Survey regression/20240704_MrsCrp_Svy.csv')
wo.num <- subset(woprs, pheno%in%c('lgCrp','SLPA54','SLPA91','SLPA92') & group %in% 'MRS_CRP')
wo.cat <- subset(woprs, pheno%in%c('DIABETES2_INDICATOR','HYPERTENSION','Insomnia','LongSlp') 
           & group%in%'MRS_CRP')
wo.num$mod<-'1' # without adjusting for PRS
wo.cat$mod<-'1'

wprs <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Survey regression/20240704_wprs.csv')
w.num <- subset(wprs, pheno%in%c('lgCrp','SLPA54','SLPA91','SLPA92'))
w.cat <- subset(wprs, pheno%in%c('DIABETES2_INDICATOR','HYPERTENSION','Insomnia','LongSlp'))
w.num$mod <- '2' # adjusting for PRS
w.cat$mod <- '2'

FigS4A <- rbind(wo.num, w.num)
FigS4B <- rbind(wo.cat, w.cat)

FigS4B$coef <- exp(FigS4B$coef)
FigS4B$lower <- exp(FigS4B$lower)
FigS4B$upper <- exp(FigS4B$upper)
```

## Fig S4A
```{r, fig.width=10}
row.names(FigS4A) <- 1:nrow(FigS4A)
sub <- split(FigS4A, FigS4A$mod) 
m1 <- sub[[1]] %>% dplyr::select(-c(group,mod))
names(m1)<-paste0('m1_', names(m1))
m2 <- sub[[2]]%>% dplyr::select(-c(group,mod)) 
names(m2) <- paste0('m2_',names(m2))

FigS4A <- cbind(m1, m2) %>% dplyr::select(-c(m2_pheno))
names(FigS4A)[1] <- 'Phenotype'

FigS4A <- rbind(FigS4A, data.frame(Phenotype= c('Association with MRS-CRP'),
                           m1_coef=rep(NA,1), m1_p.val=rep(NA,1), m1_lower=rep(NA,1), m1_upper=rep(NA,1),
                           m2_coef=rep(NA,1), m2_p.val=rep(NA,1), m2_lower=rep(NA,1), m2_upper=rep(NA,1)))
FigS4A <- FigS4A[c(5,1:4),]
row.names(FigS4A) <- 1:nrow(FigS4A)
FigS4A$Phenotype[c(2:5)] <- c('log(CRP)', 'AHI','Minimum SpO2','Mean SpO2')
FigS4A$Phenotype <- ifelse(is.na(FigS4A$m1_coef), 
                      FigS4A$Phenotype,
                      paste0("   ", FigS4A$Phenotype))
# NA to blank or NA will be transformed to carachter.
FigS4A$m1_coef <- round(FigS4A$m1_coef,3)
FigS4A$m2_coef <- round(FigS4A$m2_coef,3)
FigS4A$m1_p.val <- format(FigS4A$m1_p.val, digits=2, scientific=TRUE)
FigS4A$m2_p.val <- format(FigS4A$m2_p.val, digits=2, scientific=TRUE)

# Add two blank columns for CI
FigS4A$`95% CI` <- paste(rep(" ", 50), collapse = " ")
# Generate point estimation and 95% CI. Paste two CIs together and separate by line break.
FigS4A$m1_lower <- round(FigS4A$m1_lower,3)
FigS4A$m2_lower <- round(FigS4A$m2_lower,3)
FigS4A$m1_upper <- round(FigS4A$m1_upper,4)
FigS4A$m2_upper <- round(FigS4A$m2_upper,3)

FigS4A$CI <- paste(sprintf("(%.2f, %.2f)", FigS4A$m1_lower, FigS4A$m1_upper), 
                sprintf("(%.2f, %.2f)", FigS4A$m2_lower, FigS4A$m2_upper), 
                sep = "\n")
FigS4A$Beta <- paste(sprintf("%.2f", FigS4A$m1_coef),
                sprintf("%.2f", FigS4A$m2_coef),
                sep = "\n")
FigS4A$p.val <- paste(FigS4A$m1_p.val, FigS4A$m2_p.val,
                sep = "\n")
FigS4A$CI[grepl("NA", FigS4A$CI)] <- "" # Any NA to blank
FigS4A$Beta[grepl("NA", FigS4A$Beta)] <- "" # Any NA to blank
FigS4A$p.val[grepl("NA", FigS4A$p.val)] <- "" # Any NA to blank

#################### plot
# Set-up theme
tm <- forest_theme(base_size = 8,
                   refline_lty = "solid",
                   ci_pch = c(15, 18),
                   ci_col = c( "#AF0040","#377eb8"),
                   footnote_gp = gpar(col = "blue"),
                   legend_name = "Model",
                   legend_value = c("Without adjusting for PRS-CRP", "Adjusting for PRS-CRP" ),
                   vertline_lty = c("dashed", "dotted"),
                   vertline_col = c("#d6604d", "#bababa"),
                   # Table cell padding, width 4 and heights 3
                   )
#> refline_lty will be deprecated, use refline_gp instead.
names(FigS4A)[11]<-'95%CI'
plot <- forest(FigS4A[,c(1,12,13,11,10)], 
            est = list(FigS4A$m1_coef,
                       FigS4A$m2_coef),
            lower = list(FigS4A$m1_lower,
                         FigS4A$m2_lower),
            upper = list(FigS4A$m1_upper,
                         FigS4A$m2_upper),
            ci_column = 5,
            ref_line = 0, 
            theme = tm)
plot
```

## Fig S4B
```{r, fig.width=10}
row.names(FigS4B) <- 1:nrow(FigS4B)
sub <- split(FigS4B, FigS4B$mod) 
m1 <- sub[[1]] %>% dplyr::select(-c(group,mod))
names(m1) <- paste0('m1_', names(m1))
m2 <- sub[[2]]%>% dplyr::select(-c(group,mod))
names(m2) <- paste0('m2_', names(m2))
FigS4B <- cbind(m1,m2) %>% dplyr::select(-c(m2_pheno))
names(FigS4B)[1] <- 'Phenotype'

FigS4B <- rbind(FigS4B, data.frame(Phenotype=c('Association with MRS-CRP'),
                           m1_coef=rep(NA,1),m1_p.val=rep(NA,1), m1_lower=rep(NA,1),m1_upper=rep(NA,1),
                           m2_coef=rep(NA,1), m2_p.val=rep(NA,1),m2_lower=rep(NA,1),m2_upper=rep(NA,1) ))
FigS4B <- FigS4B[c(5,1:4),]
row.names(FigS4B) <- 1:nrow(FigS4B)
FigS4B$Phenotype[c(3:5)] <- c('Diabetes', 'Hypertension', 'Long Sleep')
FigS4B$Phenotype <- ifelse(is.na(FigS4B$m1_coef), 
                      FigS4B$Phenotype,
                      paste0("   ", FigS4B$Phenotype))
# NA to blank or NA will be transformed to carachter.
FigS4B$m1_coef<-round(FigS4B$m1_coef,3)
FigS4B$m2_coef<-round(FigS4B$m2_coef,3)
FigS4B$m1_p.val<-format(FigS4B$m1_p.val, scientific=TRUE, digits=2)
FigS4B$m2_p.val<-format(FigS4B$m2_p.val, digits=2, scientific=TRUE)

# Add two m1ank columns for CI
FigS4B$`95% CI` <- paste(rep(" ", 50), collapse = " ")
# Generate point estimation and 95% CI. Paste two CIs together and separate by line break.
FigS4B$m1_lower <- round(FigS4B$m1_lower,3)
FigS4B$m2_lower <- round(FigS4B$m2_lower,3)
FigS4B$m1_upper <- round(FigS4B$m1_upper,3)
FigS4B$m2_upper <- round(FigS4B$m2_upper,3)

FigS4B$CI <- paste(sprintf("(%.2f, %.2f)", FigS4B$m1_lower, FigS4B$m1_upper),
                sprintf("(%.2f, %.2f)", FigS4B$m2_lower, FigS4B$m2_upper),
                sep = "\n")
FigS4B$Beta <- paste(sprintf("%.2f", FigS4B$m1_coef),
                sprintf("%.2f", FigS4B$m2_coef),
                sep = "\n")
FigS4B$p.val <- paste(FigS4B$m1_p.val, FigS4B$m2_p.val,
                sep = "\n")

FigS4B$CI[grepl("NA", FigS4B$CI)] <- "" # Any NA to blank
FigS4B$Beta[grepl("NA", FigS4B$Beta)] <- "" # Any NA to blank
FigS4B$p.val[grepl("NA", FigS4B$p.val)]<- ""

#################### plot
names(FigS4B)[11] <- '95%CI'
names(FigS4B)[12] <- 'Odds Ratio'
plot <- forest(FigS4B[,c(1,12,13,11,10)], 
            est = list(FigS4B$m1_coef,
                       FigS4B$m2_coef),
            lower = list(FigS4B$m1_lower,
                         FigS4B$m2_lower),
            upper = list(FigS4B$m1_upper,
                         FigS4B$m2_upper),
            ci_column = 5,
            ref_line = 1, 
            theme = tm)
plot
```

# Create Figure S5

```{r}
### Figure S5A
preds_df <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/20240629_mrs_spline.csv')
ggplot()  +
  geom_line(data = preds_df, aes(x = SLPDUR, y = fit), color = "blue", size = 1) +
  geom_ribbon(data = preds_df, aes(x = SLPDUR, ymin = lwr, ymax = upr), alpha = 0.2, fill = "blue") +
  labs(title = "Cubic Spline Fit with GAM (k=3)",
       x = "Sleep Duration",
       y = "MRS-CRP") +
  theme_minimal()

### Figure S5B
preds_df <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/20240610_blood_spline.csv')
preds_df$group <- "Same as MRS-CRP model"

preds_df.all <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/20240629_blood_spline_all.csv')
preds_df.all$group <- "All samples"
combined_df <- rbind(preds_df, preds_df.all)

ggplot() +
  geom_line(data = combined_df, aes(x = SLPDUR, y = fit, color = group), size = 1) +
  geom_ribbon(data = combined_df, aes(x = SLPDUR, ymin = lwr, ymax = upr, fill = group), alpha = 0.2) +
  scale_color_manual(values = c("red", "blue"), name = "Sample size") +
  scale_fill_manual(values = c("red", "blue"), name = "Sample size") +
  labs(title = "Cubic Spline Fit with GAM (k=3)",
       x = "Sleep Duration",
       y = "log(Blood CRP)") +
  theme_minimal()
```

# Create Figure S6

## Read Data
```{r}
rmrs<-read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Survey regression/20240704_lgCRP_all.csv')
rprs <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Survey regression/20240704_PRS_all.csv')
rprs <- rprs[order(rprs$group),]
row.names(rprs) <- 1:nrow(rprs)
rmrs$fdr <- 1
rmrs$fdr <- p.adjust(rmrs$p.val,method='fdr')
rmrs$pheno[c(6:7)] <- c('cog_global', 'cog_change')

rprs$fdr <- 1
rprs$fdr[1:14] <- p.adjust(rprs[1:14,]$p.val,method='fdr')
rprs$fdr[15:28] <- p.adjust(rprs[15:28,]$p.val,method='fdr')
rprs$fdr[29:42] <- p.adjust(rprs[29:42,]$p.val,method='fdr')
rprs$pheno[c(3:4,17:18,31:32)] <- rep(c('cog_global', 'cog_change'), 3)

pl <- rbind(rmrs,rprs)
pl <- pl[order(pl$pheno),]
row.names(pl) <- 1:nrow(pl)
FigS6A <- pl[c(36:51, 52:55, 1:8),]
FigS6B <- pl[c(9:12, 17:20, 13:16, 21:24, 28:35),]
FigS6B$coef <- exp(FigS6B$coef)
FigS6B$lower <- exp(FigS6B$lower)
FigS6B$upper <- exp(FigS6B$upper)
```

## Fig S6A
```{r, fig.width=10}
row.names(FigS6A) <- 1:nrow(FigS6A)
sub <- split(FigS6A, FigS6A$group) 
bl <- sub[[1]] %>% dplyr::select(-c(group))
names(bl) <- paste0('bl_', names(bl))
mrs <- sub[[2]] %>% dplyr::select(-c(group)) 
names(mrs) <- paste0('mrs_', names(mrs))
ss <- sub[[3]]%>% dplyr::select(-c(group)) 
names(ss) <- paste0('ss_', names(ss))
ws <- sub[[4]] %>% dplyr::select(-c(group))
names(ws) <- paste0('ws_', names(ws))
FigS6A <- cbind(bl, mrs, ss, ws) %>% dplyr::select(-c(mrs_pheno,ss_pheno,ws_pheno))
names(FigS6A)[1] <- 'Phenotype'

FigS6A <- rbind(FigS6A, data.frame(Phenotype=c('Obstructive Sleep Apnea and Sleep Duration',
                                             'Cognitive Function'),
                              bl_coef=rep(NA,2), bl_p.val=rep(NA,2), bl_lower=rep(NA,2),
                              bl_upper=rep(NA,2), bl_fdr=rep(NA,2), mrs_coef=rep(NA,2), 
                              mrs_p.val=rep(NA,2), mrs_lower=rep(NA,2), mrs_upper=rep(NA,2), 
                              mrs_fdr=rep(NA,2), ss_coef=rep(NA,2), ss_p.val=rep(NA,2), 
                              ss_lower=rep(NA,2), ss_upper=rep(NA,2), ss_fdr=rep(NA,2), 
                              ws_coef=rep(NA,2), ws_p.val=rep(NA,2), ws_lower=rep(NA,2),
                              ws_upper=rep(NA,2), ws_fdr=rep(NA,2), bl_s.size=rep(NA,2), 
                              mrs_s.size=rep(NA,2), ss_s.size=rep(NA,2), ws_s.size=rep(NA,2)))

FigS6A <- FigS6A[c(8,1:5,9,7,6),]
row.names(FigS6A) <- 1:nrow(FigS6A)
FigS6A$Phenotype[c(2:6,8:9)]<-c('AHI','Minimum SpO2','Mean SpO2','% Time SpO2 <90',
                                'Sleep Duration', 'Baseline', 'Cognitive Change')
FigS6A$Phenotype <- ifelse(is.na(FigS6A$bl_coef), 
                      FigS6A$Phenotype,
                      paste0("   ", FigS6A$Phenotype))
# NA to blank or NA will be transformed to carachter.
FigS6A$bl_coef <- round(FigS6A$bl_coef,3)
FigS6A$mrs_coef <- round(FigS6A$mrs_coef,3)
FigS6A$ss_coef <- round(FigS6A$ss_coef,3)
FigS6A$ws_coef <- round(FigS6A$ws_coef,3)
FigS6A$bl_fdr <- format(FigS6A$bl_fdr, scientific=TRUE, digit=2)
FigS6A$mrs_fdr <- format(FigS6A$mrs_fdr, scientific=TRUE, digit=2)
FigS6A$ss_fdr <- format(FigS6A$ss_fdr, scientific=TRUE, digit=2)
FigS6A$ws_fdr <- format(FigS6A$ws_fdr, scientific=TRUE, digit=2)
FigS6A$bl_p.val <- format(FigS6A$bl_p.val, scientific=TRUE, digit=2)
FigS6A$mrs_p.val <- format(FigS6A$mrs_p.val, scientific=TRUE, digit=2)
FigS6A$ss_p.val <- format(FigS6A$ss_p.val, scientific=TRUE, digit=2)
FigS6A$ws_p.val <- format(FigS6A$ws_p.val, scientific=TRUE, digit=2)

# Add two blank columns for CI
FigS6A$`95% CI` <- paste(rep(" ", 50), collapse = " ")
# Generate point estimation and 95% CI. Paste two CIs together and separate by line break.
FigS6A$bl_lower <- round(FigS6A$bl_lower,3)
FigS6A$mrs_lower <- round(FigS6A$mrs_lower,3)
FigS6A$ss_lower <- round(FigS6A$ss_lower,3)
FigS6A$ws_lower <- round(FigS6A$ws_lower,3)
FigS6A$bl_upper <- round(FigS6A$bl_upper,4)
FigS6A$mrs_upper <- round(FigS6A$mrs_upper,3)
FigS6A$ss_upper <- round(FigS6A$ss_upper,3)
FigS6A$ws_upper <- round(FigS6A$ws_upper,3)

FigS6A$CI <- paste(sprintf("(%.2f, %.2f)", FigS6A$bl_lower, FigS6A$bl_upper), 
                sprintf("(%.2f, %.2f)", FigS6A$mrs_lower, FigS6A$mrs_upper),
                sprintf("(%.2f, %.2f)", FigS6A$ss_lower, FigS6A$ss_upper),
                sprintf("(%.2f, %.2f)", FigS6A$ws_lower, FigS6A$ws_upper),
                sep = "\n")
FigS6A$Beta <- paste(sprintf("%.2f", FigS6A$bl_coef),
                sprintf("%.2f", FigS6A$mrs_coef),
                sprintf("%.2f", FigS6A$ss_coef),
                sprintf("%.2f", FigS6A$ws_coef),
                sep = "\n")
FigS6A$q.val <- paste(FigS6A$bl_fdr, FigS6A$mrs_fdr, FigS6A$ss_fdr, FigS6A$ws_fdr,sep = "\n")
FigS6A$p.val <- paste(FigS6A$bl_p.val, FigS6A$mrs_p.val, FigS6A$ss_p.val, FigS6A$ws_p.val, sep = "\n")
FigS6A$Sample.size <- paste(FigS6A$bl_s.size, FigS6A$mrs_s.size, FigS6A$ss_s.size, 
                            FigS6A$ws_s.size,sep = "\n")

FigS6A$CI[grepl("NA", FigS6A$CI)] <- "" # Any NA to blank
FigS6A$Beta[grepl("NA", FigS6A$Beta)] <- "" # Any NA to blank
FigS6A$q.val[grepl("NA", FigS6A$q.val)] <- "" # Any NA to blank
FigS6A$p.val[grepl("NA", FigS6A$p.val)] <- "" # Any NA to blank
FigS6A$Sample.size[grepl("NA", FigS6A$Sample.size)] <- ""

#################### plot
# Set-up theme
tm <- forest_theme(base_size = 8,
                   refline_lty = "solid",
                   ci_pch = c(15, 18),
                   ci_col = c("#762a83", "#AF0040","#377eb8","#4daf4a"),
                   footnote_gp = gpar(col = "blue"),
                   legend_name = "CRP Type",
                   legend_value = c("Blood CRP", "PRS EUR", "PRS wsum all",  "PRS wsum Hispanic" ),
                   vertline_lty = c("dashed", "dotted"),
                   vertline_col = c("#d6604d", "#bababa"),
                   # Table cell padding, width 4 and heights 3
                   )
# Generate plot
names(FigS6A)[27]<-'95%CI'
plot <- forest(FigS6A[,c(1,28,27,30,29,31,26)], 
            est = list(FigS6A$bl_coef,
                       FigS6A$mrs_coef,
                       FigS6A$ss_coef,
                       FigS6A$ws_coef),
            lower = list(FigS6A$bl_lower,
                       FigS6A$mrs_lower,
                         FigS6A$ss_lower,
                        FigS6A$ws_lower), 
            upper = list(FigS6A$bl_upper,
                      FigS6A$mrs_upper,
                         FigS6A$ss_upper,
                        FigS6A$ws_upper),
            ci_column = 7,
            ref_line = 0, # 1
            theme = tm)
plot
```

## Fig S6B
```{r, fig.width=10}
row.names(FigS6B) <- 1:nrow(FigS6B)
sub <- split(FigS6B, FigS6B$group) 
bl <- sub[[1]] %>% dplyr::select(-c(group))
names(bl) <- paste0('bl_', names(bl))
mrs <- sub[[2]] %>% dplyr::select(-c(group)) 
names(mrs) <- paste0('mrs_', names(mrs))
ss <- sub[[3]]%>% dplyr::select(-c(group)) 
names(ss) <- paste0('ss_', names(ss))
ws <- sub[[4]] %>% dplyr::select(-c(group))
names(ws) <- paste0('ws_', names(ws))
FigS6B <- cbind(bl, mrs, ss, ws) %>% dplyr::select(-c(mrs_pheno,ss_pheno,ws_pheno))
names(FigS6B)[1] <- 'Phenotype'

FigS6B <- rbind(FigS6B, data.frame(Phenotype=c('Other Sleep Traits','Metabolic comorbidities'),
                              bl_coef=rep(NA,2), bl_p.val=rep(NA,2), bl_lower=rep(NA,2),
                              bl_upper=rep(NA,2), bl_fdr=rep(NA,2), mrs_coef=rep(NA,2), 
                              mrs_p.val=rep(NA,2), mrs_lower=rep(NA,2), mrs_upper=rep(NA,2), 
                              mrs_fdr=rep(NA,2), ss_coef=rep(NA,2), ss_p.val=rep(NA,2), 
                              ss_lower=rep(NA,2), ss_upper=rep(NA,2), ss_fdr=rep(NA,2), 
                              ws_coef=rep(NA,2), ws_p.val=rep(NA,2), ws_lower=rep(NA,2),
                              ws_upper=rep(NA,2), ws_fdr=rep(NA,2), bl_s.size=rep(NA,1), 
                              mrs_s.size=rep(NA,1), ss_s.size=rep(NA,1), ws_s.size=rep(NA,1) ))

FigS6B <- FigS6B[c(7,3:6, 8,1:2),]
row.names(FigS6B) <- 1:nrow(FigS6B)
FigS6B$Phenotype[c(2,4:5,7:8)] <- c('Excessive daytime sleepiness', 'Long Sleep', 
                                   'Short Sleep','Diabetes', 'Hypertension')
FigS6B$Phenotype <- ifelse(is.na(FigS6B$bl_coef), 
                      FigS6B$Phenotype,
                      paste0("   ", FigS6B$Phenotype))
# NA to blank or NA will be transformed to carachter.
FigS6B$bl_coef <- round(FigS6B$bl_coef,3)
FigS6B$mrs_coef <- round(FigS6B$mrs_coef,3)
FigS6B$ss_coef <- round(FigS6B$ss_coef,3)
FigS6B$ws_coef <- round(FigS6B$ws_coef,3)
FigS6B$bl_fdr <- format(FigS6B$bl_fdr, scientific=TRUE, digit=2)
FigS6B$mrs_fdr <- format(FigS6B$mrs_fdr, scientific=TRUE, digit=2)
FigS6B$ss_fdr <- format(FigS6B$ss_fdr, scientific=TRUE, digit=2)
FigS6B$ws_fdr <- format(FigS6B$ws_fdr, scientific=TRUE, digit=2)
FigS6B$bl_p.val <- format(FigS6B$bl_p.val, scientific=TRUE, digit=2)
FigS6B$mrs_p.val <- format(FigS6B$mrs_p.val, scientific=TRUE, digit=2)
FigS6B$ss_p.val <- format(FigS6B$ss_p.val, scientific=TRUE, digit=2)
FigS6B$ws_p.val <- format(FigS6B$ws_p.val, scientific=TRUE, digit=2)

# Add two blank columns for CI
FigS6B$`95% CI` <- paste(rep(" ", 50), collapse = " ")
# Generate point estimation and 95% CI. Paste two CIs together and separate by line break.
FigS6B$bl_lower <- round(FigS6B$bl_lower,3)
FigS6B$mrs_lower <- round(FigS6B$mrs_lower,3)
FigS6B$ss_lower <- round(FigS6B$ss_lower,3)
FigS6B$ws_lower <- round(FigS6B$ws_lower,3)
FigS6B$bl_upper <- round(FigS6B$bl_upper,4)
FigS6B$mrs_upper <- round(FigS6B$mrs_upper,3)
FigS6B$ss_upper <- round(FigS6B$ss_upper,3)
FigS6B$ws_upper <- round(FigS6B$ws_upper,3)

FigS6B$CI <- paste(sprintf("(%.2f, %.2f)", FigS6B$bl_lower, FigS6B$bl_upper), 
                sprintf("(%.2f, %.2f)", FigS6B$mrs_lower, FigS6B$mrs_upper),
                sprintf("(%.2f, %.2f)", FigS6B$ss_lower, FigS6B$ss_upper),
                sprintf("(%.2f, %.2f)", FigS6B$ws_lower, FigS6B$ws_upper),
                sep = "\n")
FigS6B$Beta <- paste(sprintf("%.2f", FigS6B$bl_coef),
                sprintf("%.2f", FigS6B$mrs_coef),
                sprintf("%.2f", FigS6B$ss_coef),
                sprintf("%.2f", FigS6B$ws_coef),
                sep = "\n")
FigS6B$q.val <- paste(FigS6B$bl_fdr, FigS6B$mrs_fdr, FigS6B$ss_fdr, FigS6B$ws_fdr,sep = "\n")
FigS6B$p.val <- paste(FigS6B$bl_p.val, FigS6B$mrs_p.val, FigS6B$ss_p.val, FigS6B$ws_p.val, sep = "\n")
FigS6B$Sample.size <- paste(FigS6B$bl_s.size, FigS6B$mrs_s.size, FigS6B$ss_s.size, 
                            FigS6B$ws_s.size,sep = "\n")

FigS6B$CI[grepl("NA", FigS6B$CI)] <- "" # Any NA to blank
FigS6B$Beta[grepl("NA", FigS6B$Beta)] <- "" # Any NA to blank
FigS6B$q.val[grepl("NA", FigS6B$q.val)] <- "" # Any NA to blank
FigS6B$p.val[grepl("NA", FigS6B$p.val)] <- "" # Any NA to blank
FigS6B$Sample.size[grepl("NA", FigS6B$Sample.size)] <- ""

# Generate plot
names(FigS6B)[27]<-'95%CI'
names(FigS6B)[28] <- 'Odds Ratio'
plot <- forest(FigS6B[,c(1,28,27,30,29,31,26)], 
            est = list(FigS6B$bl_coef,
                       FigS6B$mrs_coef,
                       FigS6B$ss_coef,
                       FigS6B$ws_coef),
            lower = list(FigS6B$bl_lower,
                       FigS6B$mrs_lower,
                         FigS6B$ss_lower,
                        FigS6B$ws_lower), 
            upper = list(FigS6B$bl_upper,
                      FigS6B$mrs_upper,
                         FigS6B$ss_upper,
                        FigS6B$ws_upper),
            ci_column = 7,
            ref_line = 1, # 1
            theme = tm)
plot
```

# Create Figure S7
## Data Preparation
```{r}
rmrs1 <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Survey regression/20240704_MrsCrp_Svy.csv')
rmrs1 <- rmrs1[1:14,]
rmrs1$fdr <- p.adjust(rmrs1$p.val,method='fdr')
rmrs1$pheno[c(7:8)] <- c('cog_global', 'cog_change')
rmrs1$group <- 'Model 1'
rmrs2 <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Survey regression/20240703_MRS_sense.csv')
rmrs2$fdr <- 1
rmrs2$fdr[1:14] <- p.adjust(rmrs2[1:14,]$p.val,method='fdr')
rmrs2$fdr[15:28] <- p.adjust(rmrs2[15:28,]$p.val,method='fdr')
rmrs2$fdr[29:42] <- p.adjust(rmrs2[29:42,]$p.val,method='fdr')
rmrs2$pheno[c(7,8,21,22,35,36)] <- rep(c('cog_global', 'cog_change'),3)

pl <- rbind(rmrs1,rmrs2)
pl <- pl[order(pl$pheno),]
row.names(pl) <- 1:nrow(pl)
FigS7A <- pl[c(37:52, 53:56, 1:8, 25:28),]
FigS7B <- pl[c(9:12, 17:20, 13:16, 21:24, 29:36),]
FigS7B$coef <- exp(FigS7B$coef)
FigS7B$lower <- exp(FigS7B$lower)
FigS7B$upper <- exp(FigS7B$upper)
```

## Forest plot for Figure S7A
```{r,fig.width=10}
row.names(FigS7A) <- 1:nrow(FigS7A)
sub <- split(FigS7A, FigS7A$group) 
bl <- sub[[2]] %>% dplyr::select(-c(group))
names(bl) <- paste0('bl_', names(bl))
mrs <- sub[[1]] %>% dplyr::select(-c(group)) 
names(mrs) <- paste0('mrs_', names(mrs))
ss <- sub[[3]]%>% dplyr::select(-c(group)) 
names(ss) <- paste0('ss_', names(ss))
ws <- sub[[4]] %>% dplyr::select(-c(group))
names(ws) <- paste0('ws_', names(ws))
FigS7A <- cbind(bl, mrs, ss, ws) %>% dplyr::select(-c(mrs_pheno,ss_pheno,ws_pheno))
names(FigS7A)[1] <- 'Phenotype'

FigS7A <- rbind(FigS7A, data.frame(Phenotype=c('Obstructive Sleep Apnea and Sleep Duration',
                                             'CRP and Cognitive Function'),
                              bl_coef=rep(NA,2), bl_p.val=rep(NA,2), bl_lower=rep(NA,2),
                              bl_upper=rep(NA,2), bl_fdr=rep(NA,2), mrs_coef=rep(NA,2), 
                              mrs_p.val=rep(NA,2), mrs_lower=rep(NA,2), mrs_upper=rep(NA,2), 
                              mrs_fdr=rep(NA,2), ss_coef=rep(NA,2), ss_p.val=rep(NA,2), 
                              ss_lower=rep(NA,2), ss_upper=rep(NA,2), ss_fdr=rep(NA,2), 
                              ws_coef=rep(NA,2), ws_p.val=rep(NA,2), ws_lower=rep(NA,2),
                              ws_upper=rep(NA,2), ws_fdr=rep(NA,2) ))

row.names(FigS7A) <- 1:nrow(FigS7A)
FigS7A <- FigS7A[c(9,1:5,10,8,7,6),]
row.names(FigS7A) <- 1:nrow(FigS7A)
FigS7A$Phenotype[c(2:6)]<-c('AHI','Minimum SpO2','Mean SpO2','% Time SpO2 <90','Sleep Duration')
FigS7A$Phenotype[c(8:10)]<-c( 'C-reactive Protein', 'Baseline', 'Cognitive Change')
FigS7A$Phenotype <- ifelse(is.na(FigS7A$bl_coef), 
                      FigS7A$Phenotype,
                      paste0("   ", FigS7A$Phenotype))
# NA to blank or NA will be transformed to carachter.
FigS7A$bl_coef <- round(FigS7A$bl_coef,3)
FigS7A$mrs_coef <- round(FigS7A$mrs_coef,3)
FigS7A$ss_coef <- round(FigS7A$ss_coef,3)
FigS7A$ws_coef <- round(FigS7A$ws_coef,3)
FigS7A$bl_fdr <- format(FigS7A$bl_fdr, scientific=TRUE, digit=2)
FigS7A$mrs_fdr <- format(FigS7A$mrs_fdr, scientific=TRUE, digit=2)
FigS7A$ss_fdr <- format(FigS7A$ss_fdr, scientific=TRUE, digit=2)
FigS7A$ws_fdr <- format(FigS7A$ws_fdr, scientific=TRUE, digit=2)
FigS7A$bl_p.val <- format(FigS7A$bl_p.val, scientific=TRUE, digit=2)
FigS7A$mrs_p.val <- format(FigS7A$mrs_p.val, scientific=TRUE, digit=2)
FigS7A$ss_p.val <- format(FigS7A$ss_p.val, scientific=TRUE, digit=2)
FigS7A$ws_p.val <- format(FigS7A$ws_p.val, scientific=TRUE, digit=2)

# Add two blank columns for CI
FigS7A$`95% CI` <- paste(rep(" ", 50), collapse = " ")
# Generate point estimation and 95% CI. Paste two CIs together and separate by line break.
FigS7A$bl_lower <- round(FigS7A$bl_lower,3)
FigS7A$mrs_lower <- round(FigS7A$mrs_lower,3)
FigS7A$ss_lower <- round(FigS7A$ss_lower,3)
FigS7A$ws_lower <- round(FigS7A$ws_lower,3)
FigS7A$bl_upper <- round(FigS7A$bl_upper,4)
FigS7A$mrs_upper <- round(FigS7A$mrs_upper,3)
FigS7A$ss_upper <- round(FigS7A$ss_upper,3)
FigS7A$ws_upper <- round(FigS7A$ws_upper,3)

FigS7A$CI <- paste(sprintf("(%.2f, %.2f)", FigS7A$bl_lower, FigS7A$bl_upper), 
                sprintf("(%.2f, %.2f)", FigS7A$mrs_lower, FigS7A$mrs_upper),
                sprintf("(%.2f, %.2f)", FigS7A$ss_lower, FigS7A$ss_upper),
                sprintf("(%.2f, %.2f)", FigS7A$ws_lower, FigS7A$ws_upper),
                sep = "\n")
FigS7A$Beta <- paste(sprintf("%.2f", FigS7A$bl_coef),
                sprintf("%.2f", FigS7A$mrs_coef),
                sprintf("%.2f", FigS7A$ss_coef),
                sprintf("%.2f", FigS7A$ws_coef),
                sep = "\n")
FigS7A$q.val <- paste(FigS7A$bl_fdr, FigS7A$mrs_fdr, FigS7A$ss_fdr, FigS7A$ws_fdr,sep = "\n")
FigS7A$p.val <- paste(FigS7A$bl_p.val, FigS7A$mrs_p.val, FigS7A$ss_p.val, FigS7A$ws_p.val, sep = "\n")

FigS7A$CI[grepl("NA", FigS7A$CI)] <- "" # Any NA to blank
FigS7A$Beta[grepl("NA", FigS7A$Beta)] <- "" # Any NA to blank
FigS7A$q.val[grepl("NA", FigS7A$q.val)] <- "" # Any NA to blank
FigS7A$p.val[grepl("NA", FigS7A$p.val)] <- "" # Any NA to blank

#################### plot
# Set-up theme
tm <- forest_theme(base_size = 8,
                   refline_lty = "solid",
                   ci_pch = c(15, 18),
                   ci_col = c("#762a83", "#AF0040","#377eb8","#4daf4a"),
                   footnote_gp = gpar(col = "blue"),
                   legend_name = "CRP Type",
                   legend_value = c("Model 1", "Cell type %", "Smoking",  "Waist-hip ratio" ),
                   vertline_lty = c("dashed", "dotted"),
                   vertline_col = c("#d6604d", "#bababa"),
                   # Table cell padding, width 4 and heights 3
                   )
# Generate plot
names(FigS7A)[23]<-'95%CI'
plot <- forest(FigS7A[,c(1,24,23,26,25,22)], 
            est = list(FigS7A$bl_coef,
                       FigS7A$mrs_coef,
                       FigS7A$ss_coef,
                       FigS7A$ws_coef),
            lower = list(FigS7A$bl_lower,
                       FigS7A$mrs_lower,
                         FigS7A$ss_lower,
                        FigS7A$ws_lower), 
            upper = list(FigS7A$bl_upper,
                      FigS7A$mrs_upper,
                         FigS7A$ss_upper,
                        FigS7A$ws_upper),
            ci_column = 6,
            ref_line = 0, # 1
            theme = tm)
plot
```

## Forest plot for Figure S7B
```{r,fig.width=10}
row.names(FigS7B) <- 1:nrow(FigS7B)
sub <- split(FigS7B, FigS7B$group) 
bl <- sub[[2]] %>% dplyr::select(-c(group))
names(bl) <- paste0('bl_', names(bl))
mrs <- sub[[1]] %>% dplyr::select(-c(group)) 
names(mrs) <- paste0('mrs_', names(mrs))
ss <- sub[[3]]%>% dplyr::select(-c(group)) 
names(ss) <- paste0('ss_', names(ss))
ws <- sub[[4]] %>% dplyr::select(-c(group))
names(ws) <- paste0('ws_', names(ws))
FigS7B <- cbind(bl, mrs, ss, ws) %>% dplyr::select(-c(mrs_pheno,ss_pheno,ws_pheno))
names(FigS7B)[1] <- 'Phenotype'

FigS7B <- rbind(FigS7B, data.frame(Phenotype=c('Other Sleep Traits','Metabolic comorbidities'),
                              bl_coef=rep(NA,2), bl_p.val=rep(NA,2), bl_lower=rep(NA,2),
                              bl_upper=rep(NA,2), bl_fdr=rep(NA,2), mrs_coef=rep(NA,2), 
                              mrs_p.val=rep(NA,2), mrs_lower=rep(NA,2), mrs_upper=rep(NA,2), 
                              mrs_fdr=rep(NA,2), ss_coef=rep(NA,2), ss_p.val=rep(NA,2), 
                              ss_lower=rep(NA,2), ss_upper=rep(NA,2), ss_fdr=rep(NA,2), 
                              ws_coef=rep(NA,2), ws_p.val=rep(NA,2), ws_lower=rep(NA,2),
                              ws_upper=rep(NA,2), ws_fdr=rep(NA,2) ))

FigS7B <- FigS7B[c(7,3:6, 8,1:2),]
row.names(FigS7B) <- 1:nrow(FigS7B)
FigS7B$Phenotype[c(2,4:5,7:8)] <- c('Excessive daytime sleepiness', 'Long Sleep', 
                                   'Short Sleep','Diabetes', 'Hypertension')
FigS7B$Phenotype <- ifelse(is.na(FigS7B$bl_coef), 
                      FigS7B$Phenotype,
                      paste0("   ", FigS7B$Phenotype))
# NA to blank or NA will be transformed to carachter.
FigS7B$bl_coef <- round(FigS7B$bl_coef,3)
FigS7B$mrs_coef <- round(FigS7B$mrs_coef,3)
FigS7B$ss_coef <- round(FigS7B$ss_coef,3)
FigS7B$ws_coef <- round(FigS7B$ws_coef,3)
FigS7B$bl_fdr <- format(FigS7B$bl_fdr, scientific=TRUE, digit=2)
FigS7B$mrs_fdr <- format(FigS7B$mrs_fdr, scientific=TRUE, digit=2)
FigS7B$ss_fdr <- format(FigS7B$ss_fdr, scientific=TRUE, digit=2)
FigS7B$ws_fdr <- format(FigS7B$ws_fdr, scientific=TRUE, digit=2)
FigS7B$bl_p.val <- format(FigS7B$bl_p.val, scientific=TRUE, digit=2)
FigS7B$mrs_p.val <- format(FigS7B$mrs_p.val, scientific=TRUE, digit=2)
FigS7B$ss_p.val <- format(FigS7B$ss_p.val, scientific=TRUE, digit=2)
FigS7B$ws_p.val <- format(FigS7B$ws_p.val, scientific=TRUE, digit=2)

# Add two blank columns for CI
FigS7B$`95% CI` <- paste(rep(" ", 50), collapse = " ")
# Generate point estimation and 95% CI. Paste two CIs together and separate by line break.
FigS7B$bl_lower <- round(FigS7B$bl_lower,3)
FigS7B$mrs_lower <- round(FigS7B$mrs_lower,3)
FigS7B$ss_lower <- round(FigS7B$ss_lower,3)
FigS7B$ws_lower <- round(FigS7B$ws_lower,3)
FigS7B$bl_upper <- round(FigS7B$bl_upper,4)
FigS7B$mrs_upper <- round(FigS7B$mrs_upper,3)
FigS7B$ss_upper <- round(FigS7B$ss_upper,3)
FigS7B$ws_upper <- round(FigS7B$ws_upper,3)

FigS7B$CI <- paste(sprintf("(%.2f, %.2f)", FigS7B$bl_lower, FigS7B$bl_upper), 
                sprintf("(%.2f, %.2f)", FigS7B$mrs_lower, FigS7B$mrs_upper),
                sprintf("(%.2f, %.2f)", FigS7B$ss_lower, FigS7B$ss_upper),
                sprintf("(%.2f, %.2f)", FigS7B$ws_lower, FigS7B$ws_upper),
                sep = "\n")
FigS7B$Beta <- paste(sprintf("%.2f", FigS7B$bl_coef),
                sprintf("%.2f", FigS7B$mrs_coef),
                sprintf("%.2f", FigS7B$ss_coef),
                sprintf("%.2f", FigS7B$ws_coef),
                sep = "\n")
FigS7B$q.val <- paste(FigS7B$bl_fdr, FigS7B$mrs_fdr, FigS7B$ss_fdr, FigS7B$ws_fdr,sep = "\n")
FigS7B$p.val <- paste(FigS7B$bl_p.val, FigS7B$mrs_p.val, FigS7B$ss_p.val, FigS7B$ws_p.val, sep = "\n")

FigS7B$CI[grepl("NA", FigS7B$CI)] <- "" # Any NA to blank
FigS7B$Beta[grepl("NA", FigS7B$Beta)] <- "" # Any NA to blank
FigS7B$q.val[grepl("NA", FigS7B$q.val)] <- "" # Any NA to blank
FigS7B$p.val[grepl("NA", FigS7B$p.val)] <- "" # Any NA to blank
names(FigS7B)[24] <- 'Odds Ratio'

#################### plot
# Generate plot
names(FigS7B)[23]<-'95%CI'
plot <- forest(FigS7B[,c(1,24,23,26,25,22)], 
            est = list(FigS7B$bl_coef,
                       FigS7B$mrs_coef,
                       FigS7B$ss_coef,
                       FigS7B$ws_coef),
            lower = list(FigS7B$bl_lower,
                       FigS7B$mrs_lower,
                         FigS7B$ss_lower,
                        FigS7B$ws_lower), 
            upper = list(FigS7B$bl_upper,
                      FigS7B$mrs_upper,
                         FigS7B$ss_upper,
                        FigS7B$ws_upper),
            ci_column = 6,
            ref_line = 1, 
            theme = tm)
plot
```


# Create Supplementary Table S6

Creation of table S3-S4 please refer to PRS_selection.Rmd

```{r}
Tab.S6 <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Survey regression/20240524_MNR_OE.csv')
Tab.S6$CI <- paste0('(', round(exp(Tab.S6$lower),2), ', ', round(exp(Tab.S6$upper),2), ')')
Tab.S6 <- Tab.S6[,c(1,2,3,5,9,8)]
names(Tab.S6) <- c('Comparison', 'PRS type', 'Odds ratio', 'p value', '95% CI', 'Sample size')
Tab.S6$Comparison <- rep(c('OSA with EDS VS no OSA', 'OSA without EDS VS no OSA', 
                           'All OSA VS no OSA'),3)
Tab.S6$`Odds ratio` <- round(exp(Tab.S6$`Odds ratio`),2)
Tab.S6$`p value` <- format(Tab.S6$`p value`, digits=1)
kable(Tab.S6, row.names = F)
#write.csv(Tab.S6, '~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Draft/Tables and Figures/Table_S6.csv', row.names = FALSE)
```

# Create Supplementary Table S7-S9

## Read Data
```{r}
ahi <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Lasso_EWAS/20240701_Enet_AHI.csv')
minO2 <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Lasso_EWAS/20240701_Enet_MinO2.csv')
diab <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Lasso_EWAS/20240701_Enet_Diab.csv')
hyp <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Results/Lasso_EWAS/20240701_Enet_hyper.csv')
tab2 <- read.csv('~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Draft/Tables and Figures/Table2.csv')
```

## Table S7
```{r}
Tab.S7 <- merge(ahi, tab2[,c(1,4)], by='CpG', all.x=T)
Tab.S7[is.na(Tab.S7)] <- ''
Tab.S7 <- Tab.S7[order(Tab.S7$Phenotypes, decreasing = T),]
Tab.S7$coef_AHI <- round(Tab.S7$coef_AHI, 2)
Tab.S7$Phenotypes <- gsub("AHI", "", Tab.S7$Phenotypes)
Tab.S7$Phenotypes <- gsub("imum", " ", Tab.S7$Phenotypes)
names(Tab.S7)[2:5] <- c('Coefficient', 'CHR', 'Gene Name', 'Overlap') 
#write.csv(Tab.S7, '~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Draft/Tables and Figures/Table_S7.csv', row.names = FALSE)
kable(head(Tab.S7), row.names = FALSE)
```

## Table S8
```{r}
Tab.S8 <- merge(minO2, tab2[,c(1,4)], by='CpG', all.x=T)
Tab.S8[is.na(Tab.S8)] <- ''
Tab.S8 <- Tab.S8[order(Tab.S8$Phenotypes, decreasing = T),]
Tab.S8$coef_MinSpO2 <- round(Tab.S8$coef_MinSpO2, 2)
Tab.S8$Phenotypes <- gsub("MinimumSpO2", "", Tab.S8$Phenotypes)
Tab.S8$Phenotypes <- gsub(",", "", Tab.S8$Phenotypes)
names(Tab.S8)[2:5] <- c('Coefficient', 'CHR', 'Gene Name', 'Overlap') 
#write.csv(Tab.S8, '~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Draft/Tables and Figures/Table_S8.csv', row.names = FALSE)
kable(head(Tab.S8), row.names = FALSE)
```

## Table S9
```{r}
Tab.diab <- merge(diab, tab2[,c(1,4)], by='CpG')
Tab.diab$Phenotypes <- gsub("Diabetes", "", Tab.diab$Phenotypes)
Tab.diab <- Tab.diab[order(Tab.diab$Phenotypes, decreasing = T),]
Tab.diab$coef_diab <- round(Tab.diab$coef_diab, 2)
Tab.diab$Trait <- 'Diabetes'
Tab.diab <- Tab.diab[,c(1,6,2:5)]
names(Tab.diab)[3:6] <- c('Coefficient', 'CHR', 'Gene Name', 'Overlap') 

Tab.hyp <- merge(hyp, tab2[,c(1,4)], by='CpG')
Tab.hyp$Phenotypes <- gsub("Hypertension", "", Tab.hyp$Phenotypes)
Tab.hyp <- Tab.hyp[order(Tab.hyp$Phenotypes, decreasing = T),]
Tab.hyp$coef_hyper <- round(Tab.hyp$coef_hyper, 2)
Tab.hyp$Trait <- 'Hypertension'
Tab.hyp <- Tab.hyp[,c(1,6,2:5)]
names(Tab.hyp)[3:6] <- c('Coefficient', 'CHR', 'Gene Name', 'Overlap') 

Tab.S9 <- rbind(Tab.diab, Tab.hyp)

#write.csv(Tab.S9, '~/OneDrive - Beth Israel Lahey Health/2023_methCRP/Draft/Tables and Figures/Table_S9.csv', row.names = FALSE)
kable(tail(Tab.S9), row.names = FALSE)
```
